for the stm32F411 discovery board


open STM Cube, select the board, select not to initialize all periphreals.
enable USB device only mode 
enable USB global interrupt


set the main clock in System Core -> RCC to HSE -> Crystal/ ceramic resonator
in the clock konfig panel select the hse form the clock path
set main pll M=4 N=96 P=2 Q=4 so we have 96MHz main clock and 48MHz also
the PLL values were calculated with i2s-clock-calc.py

------------------------- setup the audio codeck cs43l22

set up I2S3 (CS43L22)
master mode half duplex
DON'T forget to enable master clock out!

I2S philips
16b/16b 48KHz
for that set in clock (calculated by my i2s-clock-calc.py)
8MHZ main crystal -> PPL M=5, N=192, R=5, therefeore the I2S clock is 61.44MHz (it is exactly 5x 12.288MHz)
eanble DMA1 stream5 global interrup
DMA is circular increment only on memory
Priority - High
Data width: Half word
 - FiFo is optional (could help with possible cracks) - if more DMA channels are used it is not guaranteed to get data, so use a small FiFi to compensate for that, therefore DMA will transfer 4/8 samples in one go instead of 1-1 all the time


set up I2C1 (CS43L22)
100Khz 7bit


set up SPI2 (OLED display)
Transmit only master 
do NOT use the HW slave select (NSS) - http://efton.sk/STM32/gotcha/g21.html - define a generic GPIO out for this 
8bit MSB First
1.5MBit/s
CPOL Low
CPHA 1 Edge

set up DMA - DMA1 stream 4
mode normal - increment only memory - data widtht Byte
priority - low
use fifo - half full - Burst size Single
enable DMA1 stream4 gobal interrupt



used GPIO for the I2C1 and I2S3 and SPI2 shall be the correct one already defided by the board in cube MX
we need to set up a few more GPIOs for the OLED display
PE13 - OLED display reset
PE11 - OLED CMD/DATA
all are output, push pull, no pull-up or pull-down, speed - medium


GPIO for user button
- add 3 GPIO input pins with a pullup on them (no interrupt needed)

generate the project as STM Ide project and open it

------------------------- Setup USB ----------------------------------------

i gained all my knowledge based on these sources:
https://github.com/hathach/tinyusb/discussions/633#discussioncomment-342237
https://github.com/hathach/tinyusb/issues/2236
https://ejaaskel.dev/making-usb-device-with-stm32-tinyusb/
https://www.youtube.com/watch?v=ZywYPsIohcw
https://www.youtube.com/watch?v=XgsnJdY8LsY


download/checkout the tiny USB library
https://github.com/hathach/tinyusb


create a sub folder in the main project folder "tinyusb-src" and copy everithyng from tinyUSB/src
right click on this folder inside STM32 IDE 
right click - add remove include paths (add to both debug + release)
now open the project properties go to c/C++ general -> paths and symbols -> source location
and add the "tinyusb-src"

we will use the tinyusb\examples\device\uac2_speaker_fb example
from uac2_speaker_fb\src
add tusb_config.h, usb_descriptors.h, common_types.h to your "Core/Inc 
add usb_descriptors.c, to your "Core/Src 

create a folder in Core/Inc/bsp and copy tinyusb\hw\bsp\board_api.h
so we are compatible with the tinyUSB folder structure

in tusb_config.h
define the used chip and it's speed
#define CFG_TUSB_MCU    OPT_MCU_STM32F4
#define CFG_TUSB_RHPORT0_MODE   (OPT_MODE_DEVICE | OPT_MODE_FULL_SPEED)

in our main.c
 
add:
#include "bsp/board_api.h"
#include "tusb.h"
#include "common_types.h"

copy paste from tinyusb\hw\bsp\stm32f4\family.c :
size_t board_get_unique_id(uint8_t id[], size_t max_len) {
  (void) max_len;
  volatile uint32_t *stm32_uuid = (volatile uint32_t *) UID_BASE;
  uint32_t *id32 = (uint32_t *) (uintptr_t) id;
  uint8_t const len = 12;

  id32[0] = stm32_uuid[0];
  id32[1] = stm32_uuid[1];
  id32[2] = stm32_uuid[2];

  return len;
}

now add a few more geric USB things (from \tinyusb\examples\device\uac2_speaker_fb\src\main.c):
add this after the generated peripherals in  /* USER CODE BEGIN 2 */

  // init device stack on configured roothub port
  tusb_rhport_init_t dev_init = {
      .role = TUSB_ROLE_DEVICE,
      .speed = TUSB_SPEED_AUTO};
  tusb_init(BOARD_TUD_RHPORT, &dev_init);
  TU_LOG1("Speaker running\r\n"); 


set up the USB interrupt -> 
\Core\Src\stm32f4xx_it.c needs to include #include "tusb.h"
and in the USB global interrup handler 
void OTG_FS_IRQHandler(void)

tusb_int_handler(BOARD_TUD_RHPORT, true);
return;

add this as the first lines, so the STM based callback won't be called



now include the stuff form the \tinyusb\examples\device\uac2_speaker_fb\src\main.c to your project

structs/enums
the init sequence
the main loop stuff 

some of it needs to go to the main.c but the majority can be in a separtate file 
Since the code we are adding is large enough i add it as a separate file


------------------------- Setup OLED display ----------------------------------------
i found a really promissing OLED display driver for the SSD1306 i'm using
It has DMA based data transfer

https://github.com/esyywar/ssd1306_drivers/
check out the code, and copy the contents of the Inc and Src to our project's Inc and Src

create also 2 additional files UI_control.h / UI_control.c
this will be the main Uset Interface control code

add the HAL_SPI_TxCpltCallback to the UI_control.c
update the pin and port definition for the OLED GPIO for RST, D/C etc. in "ssd1306.h"